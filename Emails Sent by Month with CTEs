Порахувати відсоток імейлів від загальної кількості, що було відправлено кожному акаунту в рамках кожного місяця (кількість листів, відправлених акаунту за місяць / загальну кількість листів, відправлених за місяць всім акаунтам).
Визначити дату першого та останнього надсилання імейлів для кожного акаунту у місяці.
Використай віконні функції та результат надішли у такому форматі:
sent_month, id_account, sent_msg_percent_from_this_month, first_sent_date, last_sent_date

WITH
    union_data AS (
        SELECT
            -- Truncate the sent date to the beginning of the month
            DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH) AS sent_month,
            -- Account ID
            es.id_account AS id_account,
            -- Count of messages sent by this account in this month
            COUNT(id_message) OVER (PARTITION BY es.id_account, DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH)) AS msg_acc_month,
            -- Total count of messages sent in this month (across all accounts)
            COUNT(id_message) OVER (PARTITION BY DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH)) AS msg_total_month,
            -- First sent date for this account in this month
            MIN(DATE_ADD(s.date, INTERVAL es.sent_date DAY)) OVER (PARTITION BY es.id_account ORDER BY DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH)) AS first_sent_date,
            -- Last sent date for this account in this month
            MAX(DATE_ADD(s.date, INTERVAL es.sent_date DAY)) OVER (PARTITION BY es.id_account ORDER BY DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH)) AS last_sent_date
        FROM
            `DA.email_sent` es 
        JOIN
            `DA.account_session` acs -- Join with the account_session table
        ON
            es.id_account = acs.account_id 
        JOIN
            `DA.session` s -- Join with the session table
        ON
            acs.ga_session_id = s.ga_session_id)
SELECT
    DISTINCT sent_month,
    id_account,
    -- Calculate the percentage of messages sent by this account in this month
    (msg_acc_month / msg_total_month) * 100 AS sent_msg_percent_from_this_month,
    first_sent_date,
    last_sent_date
FROM
    Union_data

